<div class="view-container">
  <span class="title-two">Formulario de autoevaluación</span>
  <div class="mb-3"></div>
  <!-- Información docente (mantener igual) -->
  <span class="title-three">Información docente</span>
  <div class="mb-1"></div>
  <table class="table-bordered">
    <thead>
      <tr>
        <th>
          <span class="text-body-regular">Nombres y apellidos</span>
          <br />
          <span class="text-body-small-sb"
            ></span
          >
        </th>
        <th>
          <span class="text-body-regular">Num.Id</span>
          <br />
          <span class="text-body-small-sb"></span>
        </th>
        <th>
          <span class="text-body-regular">Nombre de la actividad</span>
          <br />
          <span class="text-body-small-sb"></span>
        </th>
        <th>
          <span class="text-body-regular">Tipo</span>
          <br />
          <span class="text-body-small-sb"></span>
        </th>
      </tr>
      <tr>
        <th>
          <!-- Horas totales -->
          <span class="text-body-regular">Horas totales</span>
          <br />
          <span class="text-body-small-sb"></span>
        </th>
        <th>
          <!-- Periodo -->
          <span class="text-body-regular">Periodo</span>
          <br />
          <span class="text-body-small-sb"></span>
        </th>
        <th>
          <!-- Fecha de inicio -->
          <span class="text-body-regular">Fecha de inicio</span>
          <br />
          <span class="text-body-small-sb"></span>
        </th>
        <th>
          <!-- Fecha de fin -->
          <span class="text-body-regular">Fecha de finalización</span>
          <br />
          <span class="text-body-small-sb"></span>
        </th>
      </tr>
    </thead>
  </table>

  <form [formGroup]="editSelfEvaluationForm" (ngSubmit)="onSubmit()">
    <div class="mb-3"></div>
    <!-- Descripción actividad -->
    <div class="row">
      <span class="title-three">Descripción actividad</span>
      <div class="form-floating">
        <input type="text" id="activityDescription" formControlName="activityDescription"
          class="form-control input-text"
          [ngClass]="{'error-input': editSelfEvaluationForm.get('activityDescription')?.invalid}">
        <label for="activityDescription" class="label-custom text-body-small-sb">
          <span data-toggle="tooltip" data-placement="top" title="Campo obligatorio">* </span>Descripción actividad
        </label>
      </div>
    </div>
    <div class="mb-3"></div>
    <!-- Resultados -->
    <div class="row">
      <div class="col title-three">Resultado</div>
      <div class="col title-three">ODS</div>
      <div class="col title-three">Evidencia</div>
    </div>
    <div formArrayName="results">
      <div *ngFor="let resultGroup of results.controls; let i = index" [formGroupName]="i" class="row">
        <div *ngIf="i > 0" class="mb-2"></div>
        <div class="col">
          <div class="form-floating">
            <input type="text" formControlName="result"
              class="form-control input-text"
              [ngClass]="{'error-input': isInvalidField('results.'+i+'.result')}">
            <label class="label-custom text-body-small-sb">
              <span data-toggle="tooltip" data-placement="top" title="Campo obligatorio">* </span>Resultado
            </label>
          </div>
        </div>
        <div class="col">
          <div class="form-floating">
            <select formControlName="ODS"
              class="form-select input-select text-body-custom"
              id="ods-input-{{ i }}"
              [ngClass]="{'error-input': isInvalidField('results.'+i+'.ODS')}">
              <option value="">Seleccione ODS</option>
              <option *ngFor="let ods of [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17]" [value]="ods">
                ODS {{ods}}
              </option>
            </select>
            <label for="ods-input-{{ i }}" class="label-custom text-body-small-sb">
              <span data-toggle="tooltip" data-placement="top" title="Campo obligatorio">* </span>ODS
            </label>
          </div>
          
        </div>
        <div class="col">
          <ng-container *ngIf="!editSelfEvaluationForm.get('results')?.value[i].evidence; else viewEvidenceEdit">
            <div class="file-upload-container">
              <label for="uploadFileAssessment{{ i }}" class="file-upload-label">
                <div class="file-details">
                  <p class="file-title text-body-small-sb">Evidencia</p>
                  <p class="file-name text-body-small-r"></p>
                </div>
                <input type="file" formControlName="evidence" id="uploadFileAssessment{{ i }}"
                  (change)="onEvidenceSelected($event, i)" hidden>
              </label>
              <div class="file-actions">
                <button type="button"
                  class="button-upload button-actions button-border-radius"
                  (click)="triggersEvidences('uploadFileAssessment' + i)">
                </button>
              </div>
            </div>
          </ng-container>
          <ng-template #viewEvidenceEdit>
            <div class="download-file-container">
              <div class="download-file-label">
                <span class="text-body-small-r">Soporte</span>
                <br>
                <span class="text-body-small-sb"></span>
              </div>
              <div class="file-actions">
                <button type="button"
                  class="button-actions button-delete"
                  (click)="deleteEvidenceFile(i)">
                </button>
                <button type="button"
                  class="button-actions button-download"
                  (click)="downloadEvidenceFile(i)">
                </button>
              </div>
            </div>
          </ng-template>
        </div>
        <div class="col-auto d-flex align-items-center">
          <img src="assets/icons/forms/x-icon.svg"
            alt="Eliminar resultado"
            *ngIf="i > 0" type="button" (click)="removeResultEntry(i)">
        </div>
      </div>
    </div>
    <div class="mb-2"></div>
    <div class="row">
      <div class="col">
        <button type="button" (click)="addResultEntry()"
          [disabled]="results.length >= 10"
          [ngClass]="[ results.length >= 10 ? 'button-normal-large-disabled' : 'button-normal-large' ]">
          Nuevo resultado
        </button>
      </div>
    </div>
    <div class="mb-3"></div>
    <!-- Lecciones aprendidas -->
    <div class="row">
      <div class="col">
        <span class="title-three">Lecciones aprendidas</span>
        <div formArrayName="lessonsLearned">
          <div *ngFor="let lessonGroup of lessonsLearnedArray.controls; let j = index" [formGroupName]="j" class="row">
            <div *ngIf="j > 0" class="mb-2"></div>
            <div class="col">
              <div class="form-floating">
                <input type="text" formControlName="lesson"
                  class="form-control input-text" id="learnedLesson{{ j }}">
                <label for="learnedLesson{{ j }}" class="label-custom text-body-small-sb">
                  Lección aprendida
                </label>
              </div>
            </div>
            <div class="col-auto d-flex align-items-center">
              <img src="assets/icons/forms/x-icon.svg"
                alt="Eliminar resultado" *ngIf="j > 0" type="button"
                (click)="removeLessonEntry(j)">
            </div>
          </div>
        </div>
        <div class="mb-2"></div>
        <button type="button" (click)="addLessonEntry()"
          [disabled]="lessonsLearnedArray.length >= 10"
          [ngClass]="[ lessonsLearnedArray.length >= 10 ? 'button-normal-large-disabled' : 'button-normal-large' ]">
          Nueva lección aprendida
        </button>
      </div>
      <!-- Oportunidad de mejora -->
      <div class="col">
        <span class="title-three">Oportunidad de mejora</span>
        <div formArrayName="improvementOpportunities">
          <div *ngFor="let oppGroup of improvementOpportunitiesArray.controls; let k = index" [formGroupName]="k" class="row">
            <div *ngIf="k > 0" class="mb-2"></div>
            <div class="col">
              <div class="form-floating">
                <input type="text" formControlName="opportunity"
                  class="form-control input-text" id="improvementOpportunity{{ k }}">
                <label for="improvementOpportunity{{ k }}" class="label-custom text-body-small-sb">
                  Oportunidad de mejora
                </label>
              </div>
            </div>
            <div class="col-auto d-flex align-items-center">
              <img src="assets/icons/forms/x-icon.svg"
                alt="Eliminar resultado" *ngIf="k > 0" type="button"
                (click)="removeOpportunityEntry(k)">
            </div>
          </div>
        </div>
        <div class="mb-2"></div>
        <button type="button" (click)="addOpportunityEntry()"
          [disabled]="improvementOpportunitiesArray.length >= 10"
          [ngClass]="[ improvementOpportunitiesArray.length >= 10 ? 'button-normal-large-disabled' : 'button-normal-large' ]">
          Nueva oportunidad de mejora
        </button>
      </div>
    </div>
    <div class="mb-3"></div>
    <!-- Evaluación -->
    <div class="row">
      <div class="col-3">
        <span class="title-three">Evaluación</span>
        <div class="form-floating">
          <input type="text" id="evaluation" formControlName="evaluation"
            class="form-control input-text"
            [ngClass]="{'error-input': isInvalidField('evaluation')}">
          <label for="evaluation" class="label-custom text-body-small-sb">
            <span data-toggle="tooltip" data-placement="top" title="Campo obligatorio">* </span>Evaluación
          </label>
        </div>
      </div>
    </div>
    <div class="mb-3"></div>
    <!-- Observaciones -->
    <div class="row">
      <span class="title-three">Observaciones</span>
      <input type="text" formControlName="observation" placeholder="Ingrese sus observaciones" class="observation">
    </div>
    <div class="mb-3"></div>
    <!-- Firma -->
    <div class="row" style="width:50%">
      <div class="col">
        <span class="title-three">Firma del evaluado</span>
        <ng-container *ngIf="!editSelfEvaluationForm.get('signature')?.value; else signatureLoadedEdit">
          <div class="file-upload-container">
            <label for="signature" class="file-upload-label">
              <div class="file-details">
                <p class="file-title text-body-small-sb">Firma</p>
                <p class="file-name text-body-small-r">Cargar firma (.png)</p>
              </div>
              <input type="file" formControlName="signature" id="signature" (change)="onSignatureSelected($event)" hidden>
            </label>
            <div class="file-actions">
              <button type="button" class="button-upload button-actions button-border-radius" (click)="triggersSignatureUpload()"></button>
            </div>
          </div>
        </ng-container>
        <ng-template #signatureLoadedEdit>
          <div class="download-file-container">
            <div class="file-details">
              <p class="file-title text-body-small-sb">Firma</p>
              <p class="file-name text-body-small-sb">{{ signatureFile?.name }}</p>
            </div>
            <div class="file-actions">
              <button type="button" class="button-actions button-delete" (click)="deleteSignatureFile()"></button>
              <button type="button" class="button-actions button-download" (click)="downloadSignatureFile()"></button>
            </div>
          </div>
        </ng-template>
      </div>
    </div>
    <div class="mb-3"></div>
    <!-- Previsualización PDF -->
    <div class="row" style="width:50%">
      <div class="col">
        <div class="download-file-container">
          <div class="file-details">
            <p class="file-title text-body-small-sb">Previsualización</p>
            <p class="file-name text-body-small-sb">
              Genere la previsualización de la evaluación en formato PDF
            </p>
          </div>
          <div class="file-actions">
            <button type="button" class="button-actions button-view" (click)="generatePdfPreview()"></button>
          </div>
        </div>
      </div>
    </div>
    <div class="mb-4"></div>
    <!-- Botones cancelar/guardar -->
    <div class="row row-cols-auto justify-content-center">
      <div class="col">
        <button type="button" class="button-normal" (click)="goBack()">Cancelar</button>
      </div>
      <div class="col">
        <button type="submit" class="button-normal">Guardar</button>
      </div>
    </div>
  </form>
  <div class="mb-3"></div>
  <section *ngIf="pdfUrl">
    <iframe [src]="pdfUrl" width="100%" height="600px"></iframe>
  </section>
</div>
